<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: page(~{::body})}">
<body>
<div class="header">
    <h1>运行状态 · 历史趋势</h1>
    <p th:if="${error}" th:text="${error}" class="text-danger" style="margin:.3rem 0 .6rem;"></p>
    <div th:if="${device}" style="margin-bottom:1rem;display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;">
        <a href="/data" class="btn-icon" title="返回实时数据" aria-label="返回实时数据">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15 5l-7 7 7 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span class="visually-hidden">返回实时数据</span>
        </a>
        <h2 style="margin:0;font-size:1.1rem;" th:text="${device.name} + ' - ' + ${tagName}"></h2>
        <span class="badge-accent" style="font-size:.6rem;">最近200条</span>
    </div>
</div>

<div class="card" th:if="${#lists.isEmpty(entries)}">
    <p class="text-dim">暂无历史数据</p>
</div>
<div id="noDataDyn" class="card" style="display:none;">
    <p class="text-dim">暂时无历史数据</p>
</div>

<div th:if="${!#lists.isEmpty(entries)}">
    <div class="card" style="margin-bottom:0.8rem;">
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
            <strong style="font-size:.65rem;letter-spacing:.5px;color:var(--color-text-dim);">视图</strong>
            <div class="seg">
                <button id="btnLine" class="btn-icon active" type="button" title="折线图" aria-label="折线图">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 16l5-6 4 5 5-9" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="visually-hidden">折线图</span>
                </button>
                <button id="btnTable" class="btn-icon" type="button" title="表格" aria-label="表格">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 6h16v12H4zM10 6v12M4 11.5h16" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="visually-hidden">表格</span>
                </button>
            </div>
            <div style="flex:1 0 auto"></div>
            <button id="btnPredict" class="btn-icon" type="button" title="预测" aria-label="预测">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 15l4-5 4 6 4-8 4 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="visually-hidden">预测</span>
            </button>
            <span id="predictStatus" class="text-dim" style="font-size:.7rem;display:none;">预测中...</span>
        </div>
    </div>

    <div id="chartPanel" class="card chart-wrapper" style="padding:.5rem .6rem .6rem;">
        <canvas id="histCanvas" style="width:100%;height:320px;display:block;background:#061a27;border:1px solid rgba(0,183,255,.15);border-radius:4px;"></canvas>
        <div id="chartTooltip" class="chart-tooltip" style="display:none;"></div>
        <div class="legend">
            <span><i class="lg-box"></i> 历史</span>
            <span><i class="lg-box lg-box-forecast"></i> 预测</span>
        </div>
        <div id="chartHint" class="hint" style="display:none;">当前数据非数值型，无法绘制折线图，已自动切换到表格。</div>
        <div id="metricBox" class="metrics" style="display:none;"></div>
    </div>

    <div id="tablePanel" class="card tbl-wrap" style="display:none;">
        <table class="table" style="font-size:.75rem;min-width:420px;">
            <thead>
            <tr>
                <th style="width:55%;">时间</th>
                <th style="width:45%;">值</th>
            </tr>
            </thead>
            <tbody id="histTbody">
            <tr th:each="e : ${entries}">
                <td style="font-family:var(--font-mono);" th:text="${e.timestamp}"></td>
                <td style="font-family:var(--font-mono);" th:text="${e.value}"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Inject page data -->
<script th:inline="javascript">window.__PAGE_DATA__={entries:/*[[${entries}]]*/[],deviceId:/*[[${device.id}]]*/0,tagId:/*[[${tagId}]]*/0,tagName:/*[[${tagName}]]*/''};</script>
<script th:src="@{/js/tag-history.js}" src="/js/tag-history.js" defer></script>
</body>
</html>
